# 開発ロードマップ

## 概要
このロードマップは、タスク管理アプリケーションの開発計画を示します。各フェーズの目標、タスク、期待される成果物を明確にし、開発の進捗を管理します。

## フェーズ1: 基盤構築 【完了】
開発環境の整備とプロジェクトの基本構造の確立

### 目標
- 開発環境のセットアップ
- 基本的なアプリケーション構造の実装
- ビルドパイプラインの構築

### タスク
- [x] プロジェクト構造の設計
- [x] 基本設計ドキュメントの作成
- [x] 開発環境の構築（TypeScript + React + Electron）
- [x] package.jsonの設定
- [x] ビルド設定の構築

### 成果物
- 基本的なプロジェクト構造
- 開発環境の設定ファイル
- ビルドスクリプト

## フェーズ2: UI実装 【完了】
基本的なユーザーインターフェースの実装

### 目標
- 基本的なUI要素の実装
- データの永続化機能の実装
- 設定機能の実装

### タスク
- [x] ヘッダー部分の実装
- [x] タスクリストの実装
- [x] タスクアイテムの実装
- [x] UIイベントハンドラーの実装
- [x] データの永続化処理の実装
  - [x] electron-storeの導入
  - [x] タスクデータのスキーマ定義
  - [x] 設定データのスキーマ定義
  - [x] IPCハンドラーの実装
- [x] 設定の保存と読み込み
  - [x] 最前面表示設定の永続化
  - [x] ウィンドウ位置の保存
  - [x] ウィンドウサイズの保存

### 成果物
- 基本的なUI実装
- データ永続化システム
- 設定管理システム

## フェーズ3: 開発環境の再構築と安定化 【完了】
TypeScriptへの移行とコードの品質向上

### 目標
- TypeScriptへの完全移行
- コードの品質向上
- 既存機能の安定化

### タスク
#### TypeScript移行 【完了】
- [x] TypeScript関連パッケージの追加
- [x] webpack.config.jsの更新
- [x] 基本的な型定義ファイルの作成
- [x] ESLintとPrettierの設定
- [x] メインプロセスのTypeScript化
  - [x] main.jsの移行 → main.ts
  - [x] store.jsの移行 → store.ts
  - [x] 共有型定義ファイルの作成 (src/shared/types.ts)
- [x] レンダラープロセスのTypeScript化
  - [x] Reactコンポーネントの移行
  - [x] ユーティリティ関数の移行
  - [x] TypeScript設定ファイルの作成 (tsconfig.json)
- [x] ビルドシステムの最適化
  - [x] webpack設定のElectron renderer対応
  - [x] 型チェックとビルドエラーの解決
  - [x] 必要な@typesパッケージの追加

#### 既存機能の安定化 【完了】
- [x] アイドル検知の改善
  - [x] powerMonitor実装の見直し
    - [x] エラーハンドリングの強化
    - [x] 異常値チェックの追加
    - [x] 利用可能性の確認
  - [x] イベントハンドリングの最適化
    - [x] 適応的チェック間隔の実装
    - [x] システムイベント（suspend/resume/lock/unlock）の対応
    - [x] 連続エラー時の自動復旧機能
  - [x] アイドル復帰時の処理強化
    - [x] 復帰確認機能の追加（フレームワーク実装済み）
    - [x] 手動アクティビティリセット機能
    - [x] 詳細なアイドル状態情報の提供
- [x] ウィンドウ管理の改善
  - [x] カーソル表示問題の解決
  - [x] ウィンドウフレーム設定の最適化
- [x] 作業時間計測の安定化
  - [x] タイマー精度の向上
    - [x] 高精度タイマークラス（PrecisionTimer）の実装
    - [x] ドリフト補正機能の追加
    - [x] performance.now()を使用した高精度時間計測
  - [x] 状態管理の改善
    - [x] グローバルタイマーインスタンスによる状態統一
    - [x] 複数タスク同時実行の防止
    - [x] タイマー状態の永続化と復元
    - [x] エラー状態の管理とユーザー通知

### 成果物
- [x] TypeScriptベースのメインプロセス
- [x] 型安全なデータストア
- [x] 共有型定義システム
- [x] TypeScriptベースのレンダラープロセス
- [x] 改善されたコード品質
- [x] 安定化された既存機能

### TypeScript移行の詳細
#### 完了項目
1. **main.ts**: メインプロセスのTypeScript化
   - ESモジュール形式のimport/export
   - 厳密な型定義の追加
   - JSDocコメントの追加
   - エラーハンドリングの改善

2. **store.ts**: データストアのTypeScript化
   - electron-storeの型安全な使用
   - スキーマ定義の型化
   - エクスポート形式の統一

3. **shared/types.ts**: 共有型定義
   - Task, Settings, WindowBoundsインターフェース
   - TaskStatus型定義
   - IPC通信チャンネルの定数化
   - StoreSchemaの型定義

4. **レンダラープロセスの完全移行**
   - **index.tsx**: エントリーポイントのTypeScript化
   - **App.tsx**: メインアプリケーションコンポーネント
   - **utils/timer.ts**: 時間関連ユーティリティ
   - **utils/idleDetector.ts**: アイドル検知クラス
   - **hooks/useTaskTimer.ts**: タスクタイマーカスタムフック
   - **components/TaskList.tsx**: タスクリストコンポーネント
   - **components/TaskForm.tsx**: タスクフォームコンポーネント
   - **components/TaskItem.tsx**: タスクアイテムコンポーネント

5. **tsconfig.json**: TypeScript設定
   - 厳密な型チェック設定
   - パスエイリアスの設定
   - React JSX設定

6. **ビルドシステム最適化**: 完全なTypeScript対応
   - webpack.config.jsのElectron renderer対応
   - Electron modulesの外部化設定
   - @types/electronと@types/nodeパッケージの追加
   - TypeScript型チェックの完全動作確認

#### 移行完了の成果
- 全ファイルの型安全性確保
- JSDocコメントによる文書化
- インターフェースによるプロパティ型定義
- エラーハンドリングの強化
- コードの保守性・可読性向上
- ビルドプロセスの型安全性確保
- 開発時およびビルド時の型チェック完全動作

#### アイドル検知改善の詳細（2024年12月追加）
**実装された改善内容**：

1. **IdleDetectorクラスの大幅強化**
   - **適応的チェック間隔**: アイドル状態に応じて1秒〜5秒間隔で動的調整
   - **詳細なエラーハンドリング**: 連続エラー時の自動復旧（最大10回まで）
   - **システムイベント統合**: suspend/resume/lock/unlock イベントの対応
   - **状態管理の改善**: アイドル時間、最終活動時刻の追跡

2. **powerMonitor実装の強化**
   - **利用可能性チェック**: APIの存在確認
   - **異常値検出**: 24時間を超える異常値の除外
   - **システム情報取得**: プラットフォーム情報とpowerMonitor状態の確認
   - **テスト機能**: アイドル検知機能のテスト用メソッド

3. **useTaskTimerフックの改善**
   - **アイドル状態の可視化**: isIdle, lastIdleTime の状態管理
   - **システムイベント対応**: システムサスペンド時の自動停止
   - **復帰時の処理**: スクリーンロック解除時の自動リセット
   - **ログの強化**: 詳細な動作ログの追加

4. **型定義の追加**
   - **IdleStatus**: アイドル状態の詳細情報
   - **SystemInfo**: システム情報インターフェース
   - **IdleDetectorOptions**: 設定オプションの型定義
   - **IPC_CHANNELS**: 新しい通信チャンネルの追加

**技術的な改善点**：
- エラー耐性の向上（連続エラー時の間隔延長・自動復旧）
- パフォーマンス最適化（アイドル中のチェック間隔延長）
- 精度向上（アイドル直前の短間隔チェック）
- 保守性向上（詳細なログ出力・状態管理）

**使用方法**：
```typescript
// 改善されたIdleDetectorの使用例
const unsubscribe = idleDetector.onIdleChange((isIdle: boolean, idleTime?: number) => {
  if (isIdle) {
    console.log(`アイドル状態: ${Math.round((idleTime || 0) / 1000)}秒間無活動`);
  } else {
    console.log('アクティビティが再開されました');
  }
});

// アイドル状態の詳細取得
const status = idleDetector.getIdleStatus();
console.log(`現在のアイドル状態: ${status.isIdle}, 時間: ${status.idleTime}ms`);
```

#### 作業時間計測安定化の詳細（2024年12月追加）
**実装された改善内容**：

1. **PrecisionTimerクラスの実装**
   - **高精度時間計測**: performance.now()を使用したミリ秒精度の計測
   - **ドリフト補正**: 定期更新でのタイマーずれを検出・補正
   - **状態管理**: タイマー状態の一元管理とイベント通知
   - **エラー耐性**: タイマー異常時の自動復旧機能

2. **useTaskTimerフックの大幅改善**
   - **エラーハンドリング**: 指数バックオフによる自動再試行
   - **状態同期**: グローバルタイマーとの状態同期
   - **重複防止**: 複数タスクの同時実行防止
   - **永続化**: 3秒間隔での自動保存と強制保存

3. **メインプロセスのIPCハンドラー強化**
   - **入力検証**: タスクID、時間形式の厳密な検証
   - **整合性チェック**: 時間の逆行検出、異常値の警告
   - **バックアップ機能**: 過去5回分の時間履歴保存
   - **統計情報**: 見積時間との乖離率、効率性の計算

4. **UIの改善**
   - **エラー表示**: リアルタイムエラー通知とクリア機能
   - **状態表示**: アイドル状態、エラー状態の視覚的表示
   - **デバッグ情報**: 開発モード時のタイマー詳細情報表示

**技術的な改善点**：
- タイマー精度の向上（setIntervalの不正確さを解消）
- メモリリークの防止（適切なリスナー管理）
- 競合状態の解決（グローバル状態管理）
- 障害回復力の向上（エラー時の自動復旧）

**使用方法**：
```typescript
// 高精度タイマーの使用例
import { globalTimer } from '../utils/timer';

// タイマー開始
globalTimer.start(taskId, initialTimeSeconds);

// イベントリスナー
const unsubscribe = globalTimer.addListener((event) => {
  console.log(`Total time: ${event.totalTime}s, Running: ${event.isRunning}`);
});

// タイマー停止
const finalTime = globalTimer.stop();
```

**パフォーマンス指標**：
- タイマー精度: ±50ms以内（従来の±1000ms から大幅改善）
- エラー復旧: 最大3回の自動再試行
- 保存頻度: 3秒間隔の自動保存 + 30秒ごとの定期保存
- メモリ使用量: リスナー管理による最適化

## フェーズ4: 機能改善と拡張 【進行中】
既存機能の改善と新機能の追加

### 目標
- ユーザー体験の向上
- 機能の拡張
- パフォーマンスの最適化

### タスク
#### タスク管理機能の改善
- [x] タスクの開始/一時停止の最適化
  - タスク状態の遷移を改善
  - エラーハンドリングを強化
  - UIフィードバックを追加
  - パフォーマンスを最適化
- [x] タスクの完了処理の改善
  - 詳細な完了確認ダイアログの実装
  - 完了時の統計情報の自動計算と保存
  - 完了タスクの履歴管理機能
  - 効率性分析とフィードバック表示
  - 完了タスクのバックアップと復元機能
- [x] 作業時間計測の精度向上
  - 高精度タイマーの実装
  - ドリフト補正機能の追加
  - エラーハンドリングの強化
  - 状態管理の改善

#### 自動化機能の強化
- [x] アイドル検知の信頼性向上
  - 適応的チェック間隔の実装
  - エラーハンドリングの強化
  - システムイベントの統合
  - 状態管理の改善
- [ ] 自動一時停止の動作改善
  - 一時停止の信頼性向上
  - 復帰時の処理最適化
  - ユーザー通知の改善
- [ ] バックグラウンド処理の安定化
  - システム負荷に応じた監視間隔の調整
  - メモリ使用量の最適化
  - エラー回復機能の強化

### 新規課題
#### パフォーマンス最適化
- [ ] タイマー精度のさらなる向上
  - ドリフト補正の閾値を30msに下げる
  - 適応的更新間隔の微調整
  - エラー検出の精度向上
- [ ] メモリ管理の改善
  - リスナーの適切な解放
  - 不要なデータのクリーンアップ
  - メモリリークの防止
- [ ] バックグラウンド処理の効率化
  - システムリソースの最適利用
  - 処理の優先順位付け
  - エラー時の自動復旧

### 成果物
- 改善されたタスク管理機能
- 最適化された自動化機能
- パフォーマンス改善の実装
- 安定したバックグラウンド処理

## フェーズ5: Notion連携 【待機中】
Notion APIとの連携機能の実装

### 目標
- Notion APIとの安定した連携
- データ同期機能の実装
- エラーハンドリングの実装

### タスク
#### API連携基盤
- [ ] Notion API接続の実装
- [ ] データ同期機能の実装
- [ ] エラーハンドリングの実装

#### データ同期機能
- [ ] 双方向同期の実装
- [ ] 競合解決メカニズムの実装
- [ ] オフライン対応の実装

### 成果物
- Notion連携機能
- データ同期システム
- エラーハンドリングシステム

## フェーズ6: 品質向上 【待機中】
テストの追加とパフォーマンスの最適化

### 目標
- テストカバレッジの向上
- パフォーマンスの最適化
- コードの品質向上

### タスク
#### テスト実装
- [ ] ユニットテストの追加
- [ ] 統合テストの実装
- [ ] E2Eテストの追加

#### パフォーマンス最適化
- [ ] メモリ使用量の最適化
- [ ] 起動時間の改善
- [ ] 同期処理の効率化

### 成果物
- テストスイート
- パフォーマンス最適化
- 品質メトリクス

## フェーズ7: リリース準備 【待機中】
製品リリースの準備

### 目標
- 配布用パッケージの作成
- ドキュメントの整備
- リリースプロセスの確立

### タスク
#### パッケージング
- [ ] Windows用ビルド設定
- [ ] Mac用ビルド設定
- [ ] 自動アップデート機能

#### ドキュメント整備
- [ ] インストールガイド
- [ ] ユーザーマニュアル
- [ ] API仕様書

### 成果物
- 配布用パッケージ
- 完全なドキュメント
- リリースプロセス

## マイルストーン

### マイルストーン1: 基本機能の完成
- フェーズ1-2の完了
- 基本的なタスク管理機能の実装
- データ永続化の実装

### マイルストーン2: TypeScript移行完了
- フェーズ3の完了
- 全コードのTypeScript化
- コード品質の向上

### マイルストーン3: 拡張機能の実装
- フェーズ4-5の完了
- Notion連携の実装
- 自動化機能の完成

### マイルストーン4: 製品リリース
- フェーズ6-7の完了
- テスト完了
- ドキュメント完備

## リスクと対策

### 技術的リスク
1. **TypeScript移行の複雑さ**
   - 対策: 段階的な移行
   - フォールバック: 部分的なJavaScript維持

2. **Notion API の制限**
   - 対策: レート制限の管理
   - フォールバック: ローカルキャッシュの活用

### スケジュールリスク
1. **開発リソースの制限**
   - 対策: 優先順位付けの徹底
   - フォールバック: スコープの調整

2. **技術的負債の蓄積**
   - 対策: 定期的なリファクタリング
   - フォールバック: 重要機能への集中 